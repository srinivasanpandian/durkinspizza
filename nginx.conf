# Nginx configuration for Prerender.io integration
# Replace example.com with your actual domain
# Replace http://127.0.0.1:3000 with your app's upstream server

server {
    listen 80;
    server_name example.com www.example.com;

    # Root directory for static files (if serving static files directly)
    # root /path/to/your/build;
    # index index.html;

    location / {
        try_files $uri @prerender;
    }

    location @prerender {
        # Set Prerender token header
        proxy_set_header X-Prerender-Token "63GIOd8cXk4djS1KyRyD";
        
        # Determine if request is from a crawler
        set $prerender 0;
        
        # Check for crawler user agents
        if ($http_user_agent ~* "(?i)googlebot|bingbot|baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora|pinterest|slackbot|redditbot|applebot|whatsapp|flipboard|tumblr|bitlybot|skypeuripreview|nuzzel|discordbot|google page speed|qwantify|pinterestbot|bitrix link preview|xing-contenttabreceiver|chrome-lighthouse|telegrambot") {
            set $prerender 1;
        }
        
        # Check for _escaped_fragment_ query parameter
        if ($args ~ "_escaped_fragment_") {
            set $prerender 1;
        }
        
        # If it's a crawler, proxy to Prerender
        if ($prerender = 1) {
            proxy_pass https://service.prerender.io/http://$host$request_uri;
            break;
        }
        
        # Otherwise, proxy to your Express app
        proxy_pass http://127.0.0.1:3000;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|webp|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

